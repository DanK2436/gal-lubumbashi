<div class="bg-white min-h-screen py-20">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-16">
            <span class="text-red-700 font-bold uppercase tracking-widest text-sm">Médiathèque</span>
            <h1 class="text-4xl md:text-5xl font-black text-gray-900 mt-2 uppercase">Nos Vidéos</h1>
            <p class="text-gray-600 mt-4 max-w-2xl mx-auto">Découvrez nos réalisations et projets à travers notre
                collection de vidéos professionnelles.</p>
        </div>

        <!-- Filters -->
        <div class="flex flex-wrap justify-center gap-4 mb-12">
            <button
                class="filter-btn px-6 py-2 font-bold uppercase text-sm tracking-wider border-2 border-red-700 bg-red-700 text-white transition-all"
                data-category="all">
                Toutes
            </button>
            <button
                class="filter-btn px-6 py-2 font-bold uppercase text-sm tracking-wider border-2 border-gray-300 text-gray-700 hover:border-red-700 hover:text-red-700 transition-all"
                data-category="Électricité">
                Électricité
            </button>
            <button
                class="filter-btn px-6 py-2 font-bold uppercase text-sm tracking-wider border-2 border-gray-300 text-gray-700 hover:border-red-700 hover:text-red-700 transition-all"
                data-category="Métallurgie">
                Métallurgie
            </button>
            <button
                class="filter-btn px-6 py-2 font-bold uppercase text-sm tracking-wider border-2 border-gray-300 text-gray-700 hover:border-red-700 hover:text-red-700 transition-all"
                data-category="Menuiserie">
                Menuiserie
            </button>
            <button
                class="filter-btn px-6 py-2 font-bold uppercase text-sm tracking-wider border-2 border-gray-300 text-gray-700 hover:border-red-700 hover:text-red-700 transition-all"
                data-category="Construction">
                Construction
            </button>
        </div>

        <!-- Videos Grid -->
        <div id="videos-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Videos will be loaded here dynamically -->
            <div class="text-center col-span-full py-12">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-gray-200 border-t-red-700">
                </div>
                <p class="mt-4 text-gray-500">Chargement des vidéos...</p>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { getVideos, initStorage } from '/js/storage.js';

    // Initialize storage
    initStorage();

    let allVideos = [];
    let currentCategory = 'all';

    // Function to format duration
    function formatDuration(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // Function to get YouTube video ID
    function getYouTubeID(url) {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }

    // Function to render videos
    function renderVideos(videos) {
        const container = document.getElementById('videos-container');

        if (videos.length === 0) {
            container.innerHTML = `
                <div class="text-center col-span-full py-12">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                    <p class="mt-4 text-gray-500 font-medium">Aucune vidéo disponible pour cette catégorie.</p>
                </div>
            `;
            return;
        }

        container.innerHTML = videos.map(video => {
            const videoId = getYouTubeID(video.url);
            const thumbnail = video.thumbnail || `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;

            return `
                <div class="group cursor-pointer transform transition-all duration-300 hover:scale-105" 
                     onclick="window.open('${video.url}', '_blank')">
                    <div class="relative overflow-hidden shadow-lg">
                        <img src="${thumbnail}" 
                             alt="${video.title}" 
                             class="w-full h-64 object-cover"
                             onerror="this.src='https://placehold.co/600x400?text=${encodeURIComponent(video.title)}'">
                        
                        <!-- Overlay -->
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                            <div class="absolute bottom-0 left-0 right-0 p-6">
                                <div class="flex items-center justify-center mb-4">
                                    <div class="w-16 h-16 rounded-full bg-red-700 flex items-center justify-center transform group-hover:scale-110 transition-transform">
                                        <svg class="w-8 h-8 text-white ml-1" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M8 5v14l11-7z"/>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Duration Badge -->
                        <div class="absolute top-4 right-4 bg-black/80 text-white px-2 py-1 text-sm font-bold">
                            ${formatDuration(video.durationSeconds || 0)}
                        </div>

                        <!-- Category Badge -->
                        <div class="absolute top-4 left-4">
                            <span class="bg-red-700 text-white px-3 py-1 text-xs font-bold uppercase tracking-wider">
                                ${video.category}
                            </span>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h3 class="font-bold text-lg text-gray-900 group-hover:text-red-700 transition-colors line-clamp-2">
                            ${video.title}
                        </h3>
                    </div>
                </div>
            `;
        }).join('');
    }

    // Function to filter videos
    function filterVideos(category) {
        currentCategory = category;
        const filtered = category === 'all'
            ? allVideos
            : allVideos.filter(v => v.category === category);
        renderVideos(filtered);

        // Update active button
        document.querySelectorAll('.filter-btn').forEach(btn => {
            if (btn.dataset.category === category) {
                btn.classList.remove('border-gray-300', 'text-gray-700');
                btn.classList.add('border-red-700', 'bg-red-700', 'text-white');
            } else {
                btn.classList.remove('border-red-700', 'bg-red-700', 'text-white');
                btn.classList.add('border-gray-300', 'text-gray-700');
            }
        });
    }

    // Load videos
    async function loadVideos() {
        try {
            // Wait a bit for storage to initialize
            await new Promise(resolve => setTimeout(resolve, 500));

            allVideos = await getVideos();
            console.log('Videos loaded:', allVideos);
            renderVideos(allVideos);
        } catch (error) {
            console.error('Error loading videos:', error);
            document.getElementById('videos-container').innerHTML = `
                <div class="text-center col-span-full py-12">
                    <svg class="mx-auto h-12 w-12 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p class="mt-4 text-gray-500 font-medium">Erreur lors du chargement des vidéos.</p>
                </div>
            `;
        }
    }

    // Event listeners for filters
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            filterVideos(btn.dataset.category);
        });
    });

    // Initial load
    loadVideos();
</script>
